{% extends "base.html" %}

{% block title %}Coroas de Flores - Funerária Montserrat{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <div class="row align-items-center py-5">
            <div class="col-lg-6">
                <h1 class="display-5 fw-bold mb-4">Coroas de Flores</h1>
                <p class="lead text-muted mb-4">
                    Homenageie seus entes queridos com nossas coroas de flores cuidadosamente elaboradas. 
                    Cada arranjo é criado com carinho e respeito, transmitindo paz e amor eterno.
                </p>
                <div class="d-flex align-items-center">
                    <i class="fas fa-heart text-primary me-2"></i>
                    <small class="text-muted">Feitas com amor e dedicação</small>
                </div>
            </div>
            <div class="col-lg-6">
                <img src="https://pixabay.com/get/g57ee7869b960ed6ae5c9bead7f88f7031ddf7e47a779faa613b2400dc73e5879e81eda96c58c7d2da632e5f6129d52df64bb90efad53da3eafe07907ba3b26f2_1280.jpg" 
                     alt="Arranjo Floral" class="img-fluid rounded shadow">
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <h2 class="text-center mb-5">Escolha sua Coroa de Flores</h2>
    
    <div class="row">
        {% for crown in crowns %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card crown-card h-100">
                <div class="card-img-container">
                    <img src="{{ crown.image_url }}" class="card-img-top" alt="{{ crown.name }}">
                    <div class="price-badge">
                        R$ {{ "%.2f"|format(crown.price) }}
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ crown.name }}</h5>
                    <p class="card-text text-muted flex-grow-1">{{ crown.description }}</p>
                    <button class="btn btn-primary btn-customize" 
                            data-crown-id="{{ crown.id }}"
                            data-crown-name="{{ crown.name }}"
                            data-crown-price="{{ crown.price }}"
                            data-crown-image="{{ crown.image_url }}">
                        <i class="fas fa-edit me-2"></i>Personalizar Mensagem
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Customization Modal -->
<div class="modal fade" id="customizeModal" tabindex="-1" aria-labelledby="customizeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customizeModalLabel">Personalizar Mensagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="customizeForm" method="POST" action="{{ url_for('add_to_cart') }}">
                    <input type="hidden" name="crown_id" id="crownId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="preview-container">
                                <canvas id="previewCanvas" width="400" height="300"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customMessage" class="form-label">Mensagem Personalizada</label>
                                <textarea class="form-control" id="customMessage" name="custom_message" 
                                          rows="4" placeholder="Digite sua mensagem aqui..."></textarea>
                                <div class="form-text">
                                    <small class="text-muted">Máximo 100 caracteres</small>
                                </div>
                            </div>
                            
                            <div class="selected-crown-info">
                                <h6 id="selectedCrownName"></h6>
                                <p class="text-muted mb-2" id="selectedCrownPrice"></p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="customizeForm" class="btn btn-primary">
                    <i class="fas fa-cart-plus me-2"></i>Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const customizeModal = new bootstrap.Modal(document.getElementById('customizeModal'));
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const customMessageInput = document.getElementById('customMessage');
    
    let currentCrownImage = null;
    
    // Handle customize button clicks
    document.querySelectorAll('.btn-customize').forEach(button => {
        button.addEventListener('click', function() {
            const crownId = this.dataset.crownId;
            const crownName = this.dataset.crownName;
            const crownPrice = parseFloat(this.dataset.crownPrice);
            const crownImage = this.dataset.crownImage;
            
            // Update modal content
            document.getElementById('crownId').value = crownId;
            document.getElementById('selectedCrownName').textContent = crownName;
            document.getElementById('selectedCrownPrice').textContent = `R$ ${crownPrice.toFixed(2)}`;
            
            // Load image and show modal
            loadCrownImage(crownImage);
            customizeModal.show();
        });
    });
    
    // Handle message input
    customMessageInput.addEventListener('input', function() {
        updatePreview();
    });
    
    function loadCrownImage(imageUrl) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() {
            currentCrownImage = img;
            updatePreview();
        };
        img.onerror = function() {
            // Fallback: draw a simple rectangle
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#dee2e6';
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // Draw placeholder text
            ctx.fillStyle = '#6c757d';
            ctx.font = '16px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('Imagem não disponível', canvas.width / 2, canvas.height / 2);
            
            updatePreview();
        };
        img.src = imageUrl;
    }
    
    function updatePreview() {
        if (!currentCrownImage) return;
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw crown image
        const aspectRatio = currentCrownImage.width / currentCrownImage.height;
        let drawWidth = canvas.width;
        let drawHeight = canvas.width / aspectRatio;
        
        if (drawHeight > canvas.height) {
            drawHeight = canvas.height;
            drawWidth = canvas.height * aspectRatio;
        }
        
        const x = (canvas.width - drawWidth) / 2;
        const y = (canvas.height - drawHeight) / 2;
        
        ctx.drawImage(currentCrownImage, x, y, drawWidth, drawHeight);
        
        // Draw message overlay
        const message = customMessageInput.value.trim();
        if (message) {
            // Create semi-transparent background
            const padding = 20;
            const fontSize = 16;
            ctx.font = `${fontSize}px Inter`;
            const textWidth = ctx.measureText(message).width;
            const textHeight = fontSize;
            
            const rectX = (canvas.width - textWidth - padding * 2) / 2;
            const rectY = canvas.height - textHeight - padding * 2 - 20;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(rectX, rectY, textWidth + padding * 2, textHeight + padding * 2);
            
            // Draw text
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText(message, canvas.width / 2, rectY + textHeight + padding);
        }
    }
});
</script>
{% endblock %}
